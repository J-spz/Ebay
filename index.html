<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>eBay Price Scanner</title>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.2/umd/index.min.js"></script>
  <style>
    body { font-family:sans-serif; background:#111; color:#eee; text-align:center; }
    video { width:95%; max-width:420px; border-radius:8px; margin-top:1rem; }
    #output { margin-top:1rem; background:#222; padding:1rem; border-radius:8px; }
    img { width:120px; border-radius:6px; margin-top:.5rem; }
  </style>
</head>
<body>
  <h2>ðŸ“¦ eBay Price Scanner</h2>
  <video id="preview" autoplay playsinline></video>
  <div id="output">Initializing cameraâ€¦</div>

  <script>
    const { BrowserBarcodeReader } = ZXingBrowser;
    const reader = new BrowserBarcodeReader();
    const output = document.getElementById('output');
    const video = document.getElementById('preview');

    async function startScanner() {
      try {
        const devices = await reader.listVideoInputDevices();
        const camId = devices[0]?.deviceId;
        output.innerText = "Point the camera at a barcode";
        reader.decodeFromVideoDevice(camId, video, (result, err) => {
          if (result) {
            const code = result.text;
            if (window.last !== code) {
              window.last = code;
              output.innerHTML = "ðŸ“¸ Detected: <b>" + code + "</b><br>Looking up eBayâ€¦";
              lookupEbay(code);
            }
          } else if (err && !(err instanceof ZXingBrowser.NotFoundException)) {
            console.error(err);
          }
        });
      } catch (e) {
        output.innerText = "Camera start failed: " + e;
      }
    }

    async function lookupEbay(gtin) {
      const proxy = "https://api.allorigins.win/get?url=";
      const url = encodeURIComponent(`https://www.ebay.com/sch/i.html?_nkw=${gtin}&_sop=13`);
      try {
        const res = await fetch(proxy + url);
        const html = await res.json();
        const doc = new DOMParser().parseFromString(html.contents, "text/html");
        const item = doc.querySelector(".s-item");
        if (!item) {
          output.innerHTML = `No eBay results for ${gtin}`;
          return;
        }
        const title = item.querySelector(".s-item__title")?.textContent ?? "Untitled";
        const img = item.querySelector(".s-item__image-img")?.src ?? "";
        const prices = [...doc.querySelectorAll(".s-item__price")].slice(0,3).map(p=>p.textContent.trim());
        output.innerHTML = `
          <strong>${title}</strong><br>
          <img src="${img}" alt="item"><br>
          <small>Last 3 sold prices:</small><br>${prices.join("<br>")}
        `;
      } catch (e) {
        output.innerText = "Lookup error: " + e;
      }
    }

    startScanner();
  </script>
</body>
</html>
