<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ðŸ“¦ eBay Price Scanner (Fallback)</title>
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@2.0.0-beta.3/dist/quagga.min.js"></script>
<style>
  body { background:#111; color:#eee; font-family:sans-serif; text-align:center; margin:0; }
  video { width:95%; max-width:420px; border-radius:8px; margin-top:1rem; }
  #output { background:#222; margin:1rem auto; padding:1rem; border-radius:8px; width:90%; max-width:400px; }
  img { width:120px; border-radius:6px; margin-top:.5rem; }
</style>
</head>
<body>
<h2>ðŸ“¦ eBay Price Scanner</h2>
<video id="video" autoplay playsinline></video>
<div id="output">Starting cameraâ€¦</div>

<script>
const video = document.getElementById('video');
const output = document.getElementById('output');

// âœ… 1. Manual camera init (no Quagga yet)
navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
  .then(stream => {
    video.srcObject = stream;
    output.innerText = "Camera ready â€” initializing scannerâ€¦";
    startQuagga();
  })
  .catch(err => {
    output.innerText = "Camera error: " + err.name + " " + err.message;
  });

// âœ… 2. Now load Quagga onto this live feed
function startQuagga() {
  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: video
    },
    decoder: {
      readers: ["ean_reader", "upc_reader", "upc_e_reader", "code128_reader"]
    },
    locate: true,
    numOfWorkers: 0 // disable web workers for GitHub Pages compatibility
  }, function(err) {
    if (err) {
      output.innerText = "Quagga error: " + err;
      return;
    }
    Quagga.start();
    output.innerText = "Point at a barcodeâ€¦";
  });

  Quagga.onDetected(result => {
    const code = result.codeResult.code;
    if (window.last === code) return;
    window.last = code;
    output.innerHTML = `ðŸ“¸ Detected: <b>${code}</b><br>Searching eBayâ€¦`;
    lookupEbay(code);
  });
}

async function lookupEbay(gtin) {
  const proxy = "https://api.allorigins.win/get?url=";
  const url = encodeURIComponent(`https://www.ebay.com/sch/i.html?_nkw=${gtin}&_sop=13`);
  try {
    const res = await fetch(proxy + url);
    const html = await res.json();
    const doc = new DOMParser().parseFromString(html.contents, "text/html");
    const item = doc.querySelector(".s-item");
    if (!item) {
      output.innerHTML = `No eBay results for ${gtin}`;
      return;
    }
    const title = item.querySelector(".s-item__title")?.textContent ?? "Untitled";
    const img = item.querySelector(".s-item__image-img")?.src ?? "";
    const prices = [...doc.querySelectorAll(".s-item__price")].slice(0,3).map(p=>p.textContent.trim());
    output.innerHTML = `
      <strong>${title}</strong><br>
      <img src="${img}" alt="item"><br>
      <small>Last 3 sold prices:</small><br>${prices.join("<br>")}
    `;
  } catch (e) {
    output.innerText = "Lookup error: " + e;
  }
}
</script>
</body>
</html>
